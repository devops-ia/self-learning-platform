# =============================================================================
# Exercise 1: Undeclared Variables (Easy)
# =============================================================================
# Interview scenario: The candidate must identify that referenced variables
# have no declaration and add proper variable blocks with type and default.
# =============================================================================

id: "tf-01-undeclared-variables"
title: "Variables sin declarar"
briefing: "Este recurso referencia var.ami_id y var.instance_type, pero ninguna de las dos esta declarada. terraform plan va a fallar. Declara ambas variables con su tipo y un valor por defecto."
prerequisites: []
language: "hcl"
difficulty: "easy"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_instance" "web" {
    ami           = var.ami_id
    instance_type = var.instance_type

    tags = {
      Name = "web-server"
    }
  }
hints:
  - "Fijate en las referencias var.ami_id y var.instance_type. Cada una necesita un bloque variable correspondiente."
  - "Un bloque variable tiene esta forma: variable \"nombre\" { type = string  default = \"valor\" }. Necesitas uno para ami_id y otro para instance_type."
  - "Anade antes del resource: variable \"ami_id\" { type = string  default = \"ami-0c55b159cbfafe1f0\" } y variable \"instance_type\" { type = string  default = \"t2.micro\" }."
successMessage: |
  Correcto!

  Lo que aprendiste:
  - Toda referencia var.X necesita un bloque variable "X" declarado
  - Las variables deben tener un tipo explicito (string, number, bool, list, map...)
  - Definir un default evita que Terraform pida el valor interactivamente
  - En entrevistas, este es uno de los errores mas comunes que se pide detectar

i18n:
  en:
    title: "Undeclared Variables"
    briefing: "This resource references var.ami_id and var.instance_type, but neither is declared. terraform plan will fail. Declare both variables with their type and a default value."
    hints:
      - "Look at the var.ami_id and var.instance_type references. Each one needs a corresponding variable block."
      - "A variable block looks like: variable \"name\" { type = string  default = \"value\" }. You need one for ami_id and one for instance_type."
      - "Add before the resource: variable \"ami_id\" { type = string  default = \"ami-0c55b159cbfafe1f0\" } and variable \"instance_type\" { type = string  default = \"t2.micro\" }."
    successMessage: |
      Correct!

      What you learned:
      - Every var.X reference needs a declared variable "X" block
      - Variables should have an explicit type (string, number, bool, list, map...)
      - Defining a default prevents Terraform from prompting for the value interactively
      - In interviews, this is one of the most common errors candidates are asked to detect

validations:
  - type: syntax
    errorMessage: "Falta el bloque variable para ami_id."
    check:
      match: "variable\\s+\"ami_id\"\\s*\\{"
    failMessage: |
      Error: Reference to undeclared input variable

        on main.tf line 15, in resource "aws_instance" "web":
        15:   ami = var.ami_id

      An input variable with the name "ami_id" has not been declared. This
      variable is referenced by the configuration but is not defined.

      Necesitas declarar un bloque variable "ami_id" con type y default.

  - type: syntax
    errorMessage: "Falta el bloque variable para instance_type."
    check:
      match: "variable\\s+\"instance_type\"\\s*\\{"
    failMessage: |
      Error: Reference to undeclared input variable

        on main.tf line 16, in resource "aws_instance" "web":
        16:   instance_type = var.instance_type

      An input variable with the name "instance_type" has not been declared.
      This variable is referenced by the configuration but is not defined.

      Necesitas declarar un bloque variable "instance_type" con type y default.

  - type: semantic
    errorMessage: "La variable ami_id necesita un tipo."
    check:
      custom: |
        const amiBlock = code.match(/variable\s+"ami_id"\s*\{([^}]*)\}/s);
        if (!amiBlock) {
          return { passed: false, errorMessage: "No se encontro el bloque variable \"ami_id\"." };
        }
        if (!/type\s*=\s*string/.test(amiBlock[1])) {
          return { passed: false, errorMessage: "La variable ami_id necesita type = string." };
        }
        return { passed: true };
    failMessage: |
      La variable ami_id debe tener un tipo declarado. Un AMI ID es una cadena de texto,
      asi que usa type = string.

  - type: semantic
    errorMessage: "La variable instance_type necesita un tipo."
    check:
      custom: |
        const itBlock = code.match(/variable\s+"instance_type"\s*\{([^}]*)\}/s);
        if (!itBlock) {
          return { passed: false, errorMessage: "No se encontro el bloque variable \"instance_type\"." };
        }
        if (!/type\s*=\s*string/.test(itBlock[1])) {
          return { passed: false, errorMessage: "La variable instance_type necesita type = string." };
        }
        return { passed: true };
    failMessage: |
      La variable instance_type debe tener un tipo declarado. Los tipos de instancia
      son cadenas como "t2.micro", asi que usa type = string.

  - type: intention
    errorMessage: "La variable ami_id necesita un valor por defecto."
    check:
      custom: |
        const amiBlock = code.match(/variable\s+"ami_id"\s*\{([^}]*)\}/s);
        if (!amiBlock) {
          return { passed: false, errorMessage: "No se encontro el bloque variable \"ami_id\"." };
        }
        if (!/default\s*=/.test(amiBlock[1])) {
          return { passed: false, errorMessage: "La variable ami_id necesita un default." };
        }
        return { passed: true };
    failMessage: |
      La variable ami_id debe tener un valor default para que terraform plan
      no pida el valor interactivamente. Ejemplo: default = "ami-0c55b159cbfafe1f0"

  - type: intention
    errorMessage: "La variable instance_type necesita un valor por defecto."
    check:
      custom: |
        const itBlock = code.match(/variable\s+"instance_type"\s*\{([^}]*)\}/s);
        if (!itBlock) {
          return { passed: false, errorMessage: "No se encontro el bloque variable \"instance_type\"." };
        }
        if (!/default\s*=/.test(itBlock[1])) {
          return { passed: false, errorMessage: "La variable instance_type necesita un default." };
        }
        return { passed: true };
    failMessage: |
      La variable instance_type debe tener un valor default. Sin el, Terraform
      te pedira introducir el valor cada vez. Ejemplo: default = "t2.micro"

terminalCommands:
  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.82.2...
        - Installed hashicorp/aws v5.82.2 (signed by HashiCorp)

        Terraform has created a lock file .terraform.lock.hcl to record the provider
        selections it made above. Include this file in your version control repository
        so that Terraform can guarantee to make the same selections by default when
        you run "terraform init" in the future.

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform validate":
    - when:
        not:
          match: "variable\\s+\"ami_id\"\\s*\\{"
      output: |
        Error: Reference to undeclared input variable

          on main.tf line 15, in resource "aws_instance" "web":
          15:   ami = var.ami_id

        An input variable with the name "ami_id" has not been declared. This variable
        is referenced by your configuration but has not been defined.

        Did you mean to define a variable named "ami_id"?
      exitCode: 1

    - when:
        not:
          match: "variable\\s+\"instance_type\"\\s*\\{"
      output: |
        Error: Reference to undeclared input variable

          on main.tf line 16, in resource "aws_instance" "web":
          16:   instance_type = var.instance_type

        An input variable with the name "instance_type" has not been declared.
      exitCode: 1

    - output: |
        Success! The configuration is valid.
      exitCode: 0

  "terraform plan":
    - when:
        not:
          match: "variable\\s+\"ami_id\"\\s*\\{"
      output: |
        Error: Reference to undeclared input variable

          on main.tf line 15, in resource "aws_instance" "web":
          15:   ami = var.ami_id

        An input variable with the name "ami_id" has not been declared. This variable
        is referenced by your configuration but has not been defined.
      exitCode: 1

    - when:
        not:
          match: "variable\\s+\"instance_type\"\\s*\\{"
      output: |
        Error: Reference to undeclared input variable

          on main.tf line 16, in resource "aws_instance" "web":
          16:   instance_type = var.instance_type

        An input variable with the name "instance_type" has not been declared.
      exitCode: 1

    - output: |
        Terraform used the selected providers to generate the following execution plan.
        Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web will be created
          + resource "aws_instance" "web" {
              + ami                                  = "ami-0c55b159cbfafe1f0"
              + arn                                  = (known after apply)
              + associate_public_ip_address          = (known after apply)
              + availability_zone                    = (known after apply)
              + cpu_core_count                       = (known after apply)
              + cpu_threads_per_core                 = (known after apply)
              + get_password_data                    = false
              + host_id                              = (known after apply)
              + id                                   = (known after apply)
              + instance_initiated_shutdown_behavior = (known after apply)
              + instance_state                       = (known after apply)
              + instance_type                        = "t2.micro"
              + monitoring                           = (known after apply)
              + primary_network_interface_id         = (known after apply)
              + private_dns                          = (known after apply)
              + private_ip                           = (known after apply)
              + public_dns                           = (known after apply)
              + public_ip                            = (known after apply)
              + secondary_private_ips                = (known after apply)
              + security_groups                      = (known after apply)
              + subnet_id                            = (known after apply)
              + tags                                 = {
                  + "Name" = "web-server"
                }
              + tenancy                              = (known after apply)
              + vpc_security_group_ids               = (known after apply)
            }

        Plan: 1 to add, 0 to change, 0 to destroy.
      exitCode: 0
