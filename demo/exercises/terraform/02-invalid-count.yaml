# =============================================================================
# Exercise 2: Invalid Count Type (Easy)
# =============================================================================
# Interview scenario: The candidate must spot that count is a string literal
# instead of a number, a subtle but common HCL mistake.
# =============================================================================

id: "tf-02-invalid-count"
title: "Count como string en vez de numero"
briefing: "El argumento count tiene un valor entre comillas. Terraform espera un numero, no un string. Corrige el tipo del valor."
prerequisites: []
language: "hcl"
difficulty: "easy"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_instance" "web" {
    count = "2"

    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"

    tags = {
      Name = "web-${count.index}"
    }
  }
hints:
  - "Mira el valor de count. Hay algo raro en como esta escrito?"
  - "count espera un numero entero, no un string. Las comillas hacen que sea un string."
  - "Cambia count = \"2\" por count = 2 (sin comillas)."
successMessage: |
  Correcto!

  Lo que aprendiste:
  - count debe ser un numero entero, no un string entre comillas
  - HCL distingue entre tipos: "2" (string) y 2 (number) son diferentes
  - Terraform convierte algunos tipos automaticamente, pero count es estricto
  - count.index se usa para diferenciar las instancias creadas (empieza en 0)
  - En entrevistas, este tipo de error de tipos sutiles es muy habitual

i18n:
  en:
    title: "Count as String Instead of Number"
    briefing: "The count argument has a quoted value. Terraform expects a number, not a string. Fix the value type."
    hints:
      - "Look at the count value. Is there something odd about how it's written?"
      - "count expects an integer, not a string. The quotes make it a string."
      - "Change count = \"2\" to count = 2 (without quotes)."
    successMessage: |
      Correct!

      What you learned:
      - count must be an integer, not a quoted string
      - HCL distinguishes between types: "2" (string) and 2 (number) are different
      - Terraform auto-converts some types, but count is strict
      - count.index is used to differentiate created instances (starts at 0)
      - In interviews, this kind of subtle type error is very common

validations:
  - type: syntax
    errorMessage: "count no debe ser un string entre comillas."
    check:
      not_match: "count\\s*=\\s*\""
    failMessage: |
      Error: Incorrect attribute value type

        on main.tf line 16, in resource "aws_instance" "web":
        16:   count = "2"
            |----------
            | count must be a whole number

      Inappropriate value for attribute "count": a number is required.

      El valor de count esta entre comillas, lo que lo convierte en un string.
      Terraform necesita un numero entero. Quita las comillas.

  - type: semantic
    errorMessage: "count debe ser un numero entero."
    check:
      match: "count\\s*=\\s*\\d+"
    failMessage: |
      El argumento count necesita un valor numerico. Asegurate de que el valor
      sea un numero entero sin comillas. Ejemplo: count = 2

  - type: intention
    errorMessage: "El recurso debe mantener la referencia count.index en tags."
    check:
      contains: "count.index"
    failMessage: |
      No elimines la referencia a count.index en los tags. Es necesaria para
      que cada instancia tenga un nombre unico (web-0, web-1, etc.).

terminalCommands:
  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.82.2...
        - Installed hashicorp/aws v5.82.2 (signed by HashiCorp)

        Terraform has created a lock file .terraform.lock.hcl to record the provider
        selections it made above. Include this file in your version control repository
        so that Terraform can guarantee to make the same selections by default when
        you run "terraform init" in the future.

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform validate":
    - when:
        match: "count\\s*=\\s*\""
      output: |
        Error: Incorrect attribute value type

          on main.tf line 16, in resource "aws_instance" "web":
          16:   count = "2"

        Inappropriate value for attribute "count": a number is required.
      exitCode: 1

    - output: |
        Success! The configuration is valid.
      exitCode: 0

  "terraform plan":
    - when:
        match: "count\\s*=\\s*\""
      output: |
        Error: Incorrect attribute value type

          on main.tf line 16, in resource "aws_instance" "web":
          16:   count = "2"

        Inappropriate value for attribute "count": a number is required.
      exitCode: 1

    - output: |
        Terraform used the selected providers to generate the following execution plan.
        Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web[0] will be created
          + resource "aws_instance" "web" {
              + ami                                  = "ami-0c55b159cbfafe1f0"
              + arn                                  = (known after apply)
              + associate_public_ip_address          = (known after apply)
              + availability_zone                    = (known after apply)
              + get_password_data                    = false
              + id                                   = (known after apply)
              + instance_state                       = (known after apply)
              + instance_type                        = "t2.micro"
              + monitoring                           = (known after apply)
              + primary_network_interface_id         = (known after apply)
              + private_dns                          = (known after apply)
              + private_ip                           = (known after apply)
              + public_dns                           = (known after apply)
              + public_ip                            = (known after apply)
              + secondary_private_ips                = (known after apply)
              + subnet_id                            = (known after apply)
              + tags                                 = {
                  + "Name" = "web-0"
                }
              + tenancy                              = (known after apply)
              + vpc_security_group_ids               = (known after apply)
            }

          # aws_instance.web[1] will be created
          + resource "aws_instance" "web" {
              + ami                                  = "ami-0c55b159cbfafe1f0"
              + arn                                  = (known after apply)
              + associate_public_ip_address          = (known after apply)
              + availability_zone                    = (known after apply)
              + get_password_data                    = false
              + id                                   = (known after apply)
              + instance_state                       = (known after apply)
              + instance_type                        = "t2.micro"
              + monitoring                           = (known after apply)
              + primary_network_interface_id         = (known after apply)
              + private_dns                          = (known after apply)
              + private_ip                           = (known after apply)
              + public_dns                           = (known after apply)
              + public_ip                            = (known after apply)
              + secondary_private_ips                = (known after apply)
              + subnet_id                            = (known after apply)
              + tags                                 = {
                  + "Name" = "web-1"
                }
              + tenancy                              = (known after apply)
              + vpc_security_group_ids               = (known after apply)
            }

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0
