# =============================================================================
# Exercise 3: Missing Backend and Provider Source (Medium)
# =============================================================================
# Interview scenario: The candidate must identify that the terraform block is
# missing required_providers (no provider source) and has no backend "s3"
# configuration for remote state management.
# =============================================================================

id: "tf-03-missing-backend"
title: "Backend y provider source ausentes"
briefing: "Esta configuracion crea recursos para state remoto (bucket S3 + tabla DynamoDB), pero al bloque terraform le faltan el required_providers con la source de AWS y el backend \"s3\" para almacenar el estado. Anade ambos."
prerequisites: []
language: "hcl"
difficulty: "medium"
initialCode: |
  terraform {
    required_version = ">= 1.5"
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_s3_bucket" "state" {
    bucket = "my-terraform-state"
  }

  resource "aws_dynamodb_table" "lock" {
    name         = "terraform-lock"
    billing_mode = "PAY_PER_REQUEST"
    hash_key     = "LockID"

    attribute {
      name = "LockID"
      type = "S"
    }
  }
hints:
  - "El bloque terraform solo tiene required_version. Faltan dos cosas importantes para un proyecto real de AWS."
  - "Necesitas un bloque required_providers dentro de terraform con source = \"hashicorp/aws\", y un bloque backend \"s3\" con bucket, key y region."
  - "Anade dentro del bloque terraform: required_providers { aws = { source = \"hashicorp/aws\" version = \">= 5.0\" } } y backend \"s3\" { bucket = \"my-terraform-state\" key = \"terraform.tfstate\" region = \"us-east-1\" dynamodb_table = \"terraform-lock\" }."
successMessage: |
  Correcto!

  Lo que aprendiste:
  - required_providers define de donde viene cada provider y que versiones son compatibles
  - Sin source explicita, Terraform usa el registry por defecto pero es mala practica omitirla
  - El backend "s3" almacena el state de forma remota para trabajo en equipo
  - dynamodb_table en el backend habilita el locking para evitar escrituras concurrentes
  - En produccion, siempre debes tener un backend remoto configurado

i18n:
  en:
    title: "Missing Backend and Provider Source"
    briefing: "This configuration creates remote state resources (S3 bucket + DynamoDB table), but the terraform block is missing the required_providers with the AWS source and the backend \"s3\" for state storage. Add both."
    hints:
      - "The terraform block only has required_version. Two important things are missing for a real AWS project."
      - "You need a required_providers block inside terraform with source = \"hashicorp/aws\", and a backend \"s3\" block with bucket, key, and region."
      - "Add inside the terraform block: required_providers { aws = { source = \"hashicorp/aws\" version = \">= 5.0\" } } and backend \"s3\" { bucket = \"my-terraform-state\" key = \"terraform.tfstate\" region = \"us-east-1\" dynamodb_table = \"terraform-lock\" }."
    successMessage: |
      Correct!

      What you learned:
      - required_providers defines where each provider comes from and compatible versions
      - Without an explicit source, Terraform uses the default registry but omitting it is bad practice
      - The "s3" backend stores state remotely for team collaboration
      - dynamodb_table in the backend enables locking to prevent concurrent writes
      - In production, you should always have a remote backend configured

validations:
  - type: syntax
    errorMessage: "Falta el bloque required_providers con la source de AWS."
    check:
      all:
        - contains: "required_providers"
        - match: "source\\s*=\\s*\"hashicorp/aws\""
    failMessage: |
      Error: Failed to query available provider packages

      Could not retrieve the list of available versions for provider hashicorp/aws:
      provider registry registry.terraform.io does not have a provider named
      registry.terraform.io/hashicorp/aws.

      Necesitas un bloque required_providers dentro de terraform que declare:
      aws = { source = "hashicorp/aws"  version = ">= 5.0" }

  - type: syntax
    errorMessage: "Falta el bloque backend \"s3\"."
    check:
      match: "backend\\s+\"s3\"\\s*\\{"
    failMessage: |
      Warning: No backend configured

      Terraform is using the default "local" backend, which stores state in a
      local file. This is not recommended for production or team environments.

      Anade un bloque backend "s3" dentro del bloque terraform con la configuracion
      del bucket, key y region para almacenar el estado de forma remota.

  - type: semantic
    errorMessage: "El backend S3 necesita el argumento bucket."
    check:
      custom: |
        const backendMatch = code.match(/backend\s+"s3"\s*\{([^}]*)\}/s);
        if (!backendMatch) {
          return { passed: false, errorMessage: "No se encontro el bloque backend \"s3\"." };
        }
        if (!/bucket\s*=/.test(backendMatch[1])) {
          return { passed: false, errorMessage: "El backend s3 necesita el argumento bucket." };
        }
        return { passed: true };
    failMessage: |
      Error: Missing required argument

      The argument "bucket" is required in the backend "s3" configuration.
      Especifica el nombre del bucket S3 donde se almacenara el state.

  - type: semantic
    errorMessage: "El backend S3 necesita el argumento key."
    check:
      custom: |
        const backendMatch = code.match(/backend\s+"s3"\s*\{([^}]*)\}/s);
        if (!backendMatch) {
          return { passed: false, errorMessage: "No se encontro el bloque backend \"s3\"." };
        }
        if (!/key\s*=/.test(backendMatch[1])) {
          return { passed: false, errorMessage: "El backend s3 necesita el argumento key." };
        }
        return { passed: true };
    failMessage: |
      Error: Missing required argument

      The argument "key" is required in the backend "s3" configuration.
      El key es la ruta dentro del bucket donde se guarda el fichero de state
      (por ejemplo: "terraform.tfstate" o "env/prod/terraform.tfstate").

  - type: semantic
    errorMessage: "El backend S3 necesita el argumento region."
    check:
      custom: |
        const backendMatch = code.match(/backend\s+"s3"\s*\{([^}]*)\}/s);
        if (!backendMatch) {
          return { passed: false, errorMessage: "No se encontro el bloque backend \"s3\"." };
        }
        if (!/region\s*=/.test(backendMatch[1])) {
          return { passed: false, errorMessage: "El backend s3 necesita el argumento region." };
        }
        return { passed: true };
    failMessage: |
      Error: Missing required argument

      The argument "region" is required in the backend "s3" configuration.
      Indica la region de AWS donde esta el bucket S3 del state.

  - type: intention
    errorMessage: "El backend deberia usar la tabla DynamoDB para locking."
    check:
      custom: |
        const backendMatch = code.match(/backend\s+"s3"\s*\{([^}]*)\}/s);
        if (!backendMatch) {
          return { passed: false, errorMessage: "No se encontro el bloque backend \"s3\"." };
        }
        if (!/dynamodb_table\s*=/.test(backendMatch[1])) {
          return { passed: false, errorMessage: "Falta dynamodb_table en el backend para el locking del state." };
        }
        return { passed: true };
    failMessage: |
      Warning: No state locking configured

      Without state locking, multiple team members could modify the state
      simultaneously, potentially corrupting it.

      Anade dynamodb_table = "terraform-lock" al backend para habilitar el
      locking del state usando la tabla DynamoDB que ya estas creando.

terminalCommands:
  "terraform init":
    - when:
        not:
          all:
            - contains: "required_providers"
            - match: "source\\s*=\\s*\"hashicorp/aws\""
      output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding latest version of hashicorp/aws...

        Error: Failed to query available provider packages

        Could not retrieve the list of available versions for provider
        hashicorp/aws: provider registry registry.terraform.io does not have a
        provider named registry.terraform.io/hashicorp/aws.

        To install this provider, add the following to your required_providers
        block inside the terraform {} block:

          aws = {
            source = "hashicorp/aws"
          }
      exitCode: 1

    - when:
        not:
          match: "backend\\s+\"s3\"\\s*\\{"
      output: |
        Initializing the backend...

        Successfully configured the backend "local"!

        Warning: No remote backend configured. State will be stored locally in
        terraform.tfstate. This is not recommended for team environments.

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.82.2...
        - Installed hashicorp/aws v5.82.2 (signed by HashiCorp)

        Terraform has been successfully initialized!

        Note: You have not configured a remote backend. Consider adding a
        backend "s3" block for remote state storage.
      exitCode: 0

    - output: |
        Initializing the backend...

        Successfully configured the backend "s3"!

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.82.2...
        - Installed hashicorp/aws v5.82.2 (signed by HashiCorp)

        Terraform has created a lock file .terraform.lock.hcl to record the provider
        selections it made above. Include this file in your version control repository
        so that Terraform can guarantee to make the same selections by default when
        you run "terraform init" in the future.

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform validate":
    - when:
        not:
          all:
            - contains: "required_providers"
            - match: "source\\s*=\\s*\"hashicorp/aws\""
      output: |
        Error: Could not load plugin

        Plugin reinitialization required. Please run "terraform init".

        Plugins are external binaries that Terraform uses to access and manipulate
        resources. The configuration provided requires plugins which can't be located.
      exitCode: 1

    - output: |
        Success! The configuration is valid.
      exitCode: 0

  "terraform plan":
    - when:
        not:
          all:
            - contains: "required_providers"
            - match: "source\\s*=\\s*\"hashicorp/aws\""
      output: |
        Error: Could not load plugin

        Plugin reinitialization required. Please run "terraform init".
      exitCode: 1

    - when:
        not:
          match: "backend\\s+\"s3\"\\s*\\{"
      output: |
        Terraform used the selected providers to generate the following execution plan.
        Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_s3_bucket.state will be created
          + resource "aws_s3_bucket" "state" {
              + arn                         = (known after apply)
              + bucket                      = "my-terraform-state"
              + id                          = (known after apply)
              + region                      = (known after apply)
            }

          # aws_dynamodb_table.lock will be created
          + resource "aws_dynamodb_table" "lock" {
              + arn              = (known after apply)
              + billing_mode     = "PAY_PER_REQUEST"
              + hash_key         = "LockID"
              + id               = (known after apply)
              + name             = "terraform-lock"
            }

        Plan: 2 to add, 0 to change, 0 to destroy.

        Warning: State is stored locally. Configure a remote backend for team use.
      exitCode: 0

    - output: |
        Acquiring state lock. This may take a few moments...

        Terraform used the selected providers to generate the following execution plan.
        Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_s3_bucket.state will be created
          + resource "aws_s3_bucket" "state" {
              + arn                         = (known after apply)
              + bucket                      = "my-terraform-state"
              + id                          = (known after apply)
              + region                      = (known after apply)
            }

          # aws_dynamodb_table.lock will be created
          + resource "aws_dynamodb_table" "lock" {
              + arn              = (known after apply)
              + billing_mode     = "PAY_PER_REQUEST"
              + hash_key         = "LockID"
              + id               = (known after apply)
              + name             = "terraform-lock"
            }

        Plan: 2 to add, 0 to change, 0 to destroy.

        Releasing state lock. This may take a few moments...
      exitCode: 0
