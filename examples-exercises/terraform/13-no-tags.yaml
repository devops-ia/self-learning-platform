id: tf-13-no-tags
title: "Recursos sin tags"
briefing: "Estos recursos no tienen tags. En produccion, los tags son obligatorios para control de costes y organizacion. Anade los tags necesarios."

prerequisites: []

initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_instance" "web" {
    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"
  }

  resource "aws_s3_bucket" "data" {
    bucket = "my-app-data-bucket"
  }

hints:
  - "Los tags en AWS se definen dentro de un bloque tags = { ... } en cada recurso."
  - "Como minimo, necesitas los tags Environment y Name para identificar y agrupar recursos."
  - "Anade un bloque tags = { Name = \"web-server\", Environment = \"production\" } a cada recurso."

successMessage: |
  Perfecto! Los recursos ahora tienen tags correctos.

  Lo que aprendiste:
  - Los tags son metadatos clave-valor que organizan recursos en AWS
  - Sin tags, es imposible hacer seguimiento de costes por equipo o proyecto
  - Las buenas practicas exigen al menos Name y Environment en cada recurso
  - Puedes usar aws_default_tags en el provider para aplicar tags globales

i18n:
  en:
    title: "Resources without tags"
    briefing: "These resources don't have tags. In production, tags are mandatory for cost control and organization. Add the required tags."
    hints:
      - "Tags in AWS are defined inside a tags = { ... } block in each resource."
      - "At minimum, you need the Environment and Name tags to identify and group resources."
      - 'Add a tags = { Name = "web-server", Environment = "production" } block to each resource.'
    successMessage: |
      Correct! Resources now have proper tags.

      What you learned:
      - Tags are key-value metadata that organize resources in AWS
      - Without tags, it's impossible to track costs by team or project
      - Best practices require at least Name and Environment on each resource
      - You can use aws_default_tags in the provider to apply global tags

validations:
  - type: syntax
    errorMessage: "El recurso aws_instance debe tener un bloque tags."
    check:
      custom: |
        const instanceMatch = code.match(/resource\s+"aws_instance"\s+"web"\s*\{([\s\S]*?)\n\}/);
        if (!instanceMatch) return { passed: true };
        if (!instanceMatch[1].includes("tags")) {
          return { passed: false, errorMessage: "Error: el recurso aws_instance \"web\" no tiene tags.\n\nEn produccion, todos los recursos deben tener tags para control de costes y organizacion. Anade un bloque tags = { ... } dentro del recurso." };
        }
        return { passed: true };
    failMessage: ""

  - type: syntax
    errorMessage: "El recurso aws_s3_bucket debe tener un bloque tags."
    check:
      custom: |
        const bucketMatch = code.match(/resource\s+"aws_s3_bucket"\s+"data"\s*\{([\s\S]*?)\n\}/);
        if (!bucketMatch) return { passed: true };
        if (!bucketMatch[1].includes("tags")) {
          return { passed: false, errorMessage: "Error: el recurso aws_s3_bucket \"data\" no tiene tags.\n\nTodos los recursos de AWS deben tener tags. Sin ellos, no puedes filtrar por equipo, proyecto o entorno en la factura de AWS." };
        }
        return { passed: true };
    failMessage: ""

  - type: semantic
    errorMessage: "Cada recurso debe tener al menos los tags Name y Environment."
    check:
      all:
        - match: 'Name\s*='
        - match: 'Environment\s*='
    failMessage: |
      Error: tags incompletos

      Como minimo necesitas los tags Name y Environment en cada recurso:
        tags = {
          Name        = "nombre-descriptivo"
          Environment = "production"
        }

terminalCommands:
  "terraform plan":
    - when:
        custom: |
          const instanceMatch = code.match(/resource\s+"aws_instance"\s+"web"\s*\{([\s\S]*?)\n\}/);
          const bucketMatch = code.match(/resource\s+"aws_s3_bucket"\s+"data"\s*\{([\s\S]*?)\n\}/);
          return (!instanceMatch || !instanceMatch[1].includes("tags")) || (!bucketMatch || !bucketMatch[1].includes("tags"));
      output: |
        Warning: resource has no tags

        Best practice requires tags on all resources for cost tracking
        and organization. Add tags = { ... } to each resource.
      exitCode: 1

    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web will be created
          + resource "aws_instance" "web" {
              + ami           = "ami-0c55b159cbfafe1f0"
              + instance_type = "t2.micro"
              + tags          = {
                  + "Name"        = "web-server"
                  + "Environment" = "production"
                }
            }

          # aws_s3_bucket.data will be created
          + resource "aws_s3_bucket" "data" {
              + bucket = "my-app-data-bucket"
              + tags   = {
                  + "Name"        = "app-data"
                  + "Environment" = "production"
                }
            }

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform apply":
    - output: 'Error: This is a simulated environment. Use "terraform plan" to validate your configuration.'
      exitCode: 1
