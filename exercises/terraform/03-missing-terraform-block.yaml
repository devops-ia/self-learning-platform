id: "tf-03-missing-terraform-block"
title: "Bloque terraform ausente"
briefing: "terraform init no puede continuar sin el bloque terraform. Identifica qué falta y corrígelo para que la inicialización funcione."
prerequisites: []
language: "hcl"
initialCode: |
  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_instance" "web" {
    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"

    tags = {
      Name = "web-server"
    }
  }

hints:
  - "Ejecuta terraform init y observa el error. Terraform te dice que necesita un bloque terraform con required_providers."
  - "El bloque terraform { } va al principio del archivo y dentro lleva required_providers { aws = { source = ... } }."
  - "Solución: añade un bloque terraform { required_providers { aws = { source = \"hashicorp/aws\" version = \">= 5.0\" } } } antes del provider."
successMessage: |
  ¡Correcto! El bloque terraform está en su sitio.

  Lo que aprendiste:
  - El bloque terraform { } es obligatorio para configurar el propio Terraform
  - required_providers declara qué providers necesita tu configuración
  - Sin source = "hashicorp/aws", Terraform no sabe de dónde descargar el plugin
  - terraform init lee este bloque para descargar e instalar los providers

i18n:
  en:
    title: "Missing terraform block"
    briefing: "terraform init cannot continue without the terraform block. Identify what's missing and fix it so initialization works."
    hints:
      - "Run terraform init and observe the error. Terraform tells you it needs a terraform block with required_providers."
      - "The terraform { } block goes at the beginning of the file and contains required_providers { aws = { source = ... } }."
      - "Solution: add a terraform { required_providers { aws = { source = \"hashicorp/aws\" version = \">= 5.0\" } } } block before the provider."
    successMessage: |
      Correct! The terraform block is in place.

      What you learned:
      - The terraform { } block is mandatory to configure Terraform itself
      - required_providers declares which providers your configuration needs
      - Without source = "hashicorp/aws", Terraform doesn't know where to download the plugin
      - terraform init reads this block to download and install providers

validations:
  - type: syntax
    errorMessage: "Falta el bloque terraform { }."
    check:
      not_match: 'terraform\s*\{'
    failMessage: |
      Error: Missing terraform block

      Terraform necesita un bloque terraform { } en la raíz de la configuración. Este bloque contiene la configuración del propio Terraform, como los providers requeridos y la versión mínima.

  - type: semantic
    errorMessage: "Falta el bloque required_providers dentro de terraform."
    check:
      not_match: 'required_providers\s*\{'
    failMessage: |
      Error: Missing required_providers block

      Dentro del bloque terraform { }, necesitas un bloque required_providers { } que declare los providers que usa tu configuración. Sin esto, terraform init no puede descargar los plugins necesarios.

  - type: intention
    errorMessage: "El required_providers debe especificar la source del provider de AWS."
    check:
      any:
        - not_contains: "required_providers"
        - contains: "hashicorp/aws"
    failMessage: |
      Error: Missing provider source

      El bloque required_providers debe incluir la source del provider: source = "hashicorp/aws". Esto indica a Terraform de dónde descargar el plugin.

terminalCommands:
  "terraform init":
    - when:
        not_match: 'terraform\s*\{'
      output: |
        Initializing the backend...

        Initializing provider plugins...

        ╷
        │ Error: Failed to query available provider packages
        │
        │ Could not retrieve the list of available versions for provider
        │ hashicorp/aws: provider registry registry.terraform.io does not have a
        │ provider named registry.terraform.io/hashicorp/aws
        │
        │ A terraform block with required_providers is needed to configure
        │ provider installation.
        ╵
      exitCode: 1
    - when:
        not_contains: "required_providers"
      output: |
        Initializing the backend...

        Initializing provider plugins...

        ╷
        │ Error: Failed to query available provider packages
        │
        │ Could not retrieve the list of available versions for provider
        │ hashicorp/aws: the terraform block does not contain a "required_providers"
        │ block with an entry for this provider.
        ╵
      exitCode: 1
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform plan":
    - when:
        any:
          - not_match: 'terraform\s*\{'
          - not_contains: "required_providers"
      output: |
        ╷
        │ Error: Inconsistent dependency lock file
        │
        │ provider registry.terraform.io/hashicorp/aws: required by this
        │ configuration but no version is selected
        │
        │ Run "terraform init" first.
        ╵
      exitCode: 1
    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web will be created
          + resource "aws_instance" "web" {
              + ami                          = "ami-0c55b159cbfafe1f0"
              + instance_type                = "t2.micro"
              + id                           = (known after apply)
              + arn                          = (known after apply)
              + public_ip                    = (known after apply)
            }

        Plan: 1 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform apply":
    - output: "Error: This is a simulated environment. Use \"terraform plan\" to validate your configuration."
      exitCode: 1
