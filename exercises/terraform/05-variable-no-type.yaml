id: "tf-05-variable-no-type"
title: "Variable sin tipo"
briefing: "Esta variable tiene default = \"2\" pero se usa con count. Sin tipo explícito, Terraform hará coerción implícita. Corrige la definición para que sea segura."
prerequisites: []
language: "hcl"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  variable "instance_count" {
    default = "2"
  }

  resource "aws_instance" "web" {
    count         = var.instance_count
    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"
  }

hints:
  - "La variable tiene default = \"2\" (entre comillas, es un string). Pero count necesita un número. ¿Qué falta en la definición de la variable?"
  - "Añade type = number a la variable. Esto obliga a que el valor sea numérico y evita coerciones implícitas."
  - "Solución: cambia la variable a: variable \"instance_count\" { type = number  default = 2 }"
successMessage: |
  ¡Correcto! La variable ahora tiene tipo explícito.

  Lo que aprendiste:
  - Siempre define type en tus variables para evitar coerciones implícitas
  - default = "2" es un string; default = 2 es un número
  - count requiere un valor numérico, no un string
  - Los tipos básicos en Terraform son: string, number, bool, list, map, object

i18n:
  en:
    title: "Variable without type"
    briefing: "This variable has default = \"2\" but is used with count. Without an explicit type, Terraform will do implicit coercion. Fix the definition to make it safe."
    hints:
      - "The variable has default = \"2\" (in quotes, it's a string). But count needs a number. What's missing in the variable definition?"
      - "Add type = number to the variable. This forces the value to be numeric and avoids implicit coercions."
      - "Solution: change the variable to: variable \"instance_count\" { type = number  default = 2 }"
    successMessage: |
      Correct! The variable now has an explicit type.

      What you learned:
      - Always define type in your variables to avoid implicit coercions
      - default = "2" is a string; default = 2 is a number
      - count requires a numeric value, not a string
      - Basic types in Terraform are: string, number, bool, list, map, object

validations:
  - type: syntax
    errorMessage: "La variable debe tener un tipo explícito."
    check:
      not_match: 'type\s*='
    failMessage: |
      Error: Variable sin tipo explícito

      La variable "instance_count" tiene default = "2" (un string), pero se usa como número.
      Sin un tipo explícito, Terraform hace coerción implícita que puede causar errores sutiles.
      Añade type = number para que Terraform valide el tipo correctamente.

  - type: semantic
    errorMessage: "El tipo de la variable debe ser number."
    check:
      not_match: 'type\s*=\s*number'
    failMessage: |
      Error: El tipo de la variable debería ser number

      La variable instance_count se usa con count, que requiere un número.
      Usa type = number para que el default también sea numérico.

  - type: intention
    errorMessage: "El default debe coincidir con el tipo declarado."
    check:
      custom: |
        (code) => {
          if (/default\s*=\s*"/.test(code) && /type\s*=\s*number/.test(code)) {
            return {
              passed: false,
              errorMessage: `Error: Conflicto entre tipo y valor por defecto

        Has definido type = number pero el default sigue siendo un string ("2").
        Cambia default = "2" a default = 2 (sin comillas) para que coincida con el tipo.`
            };
          }
          return { passed: true };
        }
    failMessage: |
      Error: Conflicto entre tipo y valor por defecto

      Has declarado type = number en la variable, pero el valor default sigue siendo
      un string con comillas: default = "2".

      Para que el tipo y el valor coincidan, quita las comillas del default:
      default = 2 (sin comillas, es un número).

      Si el tipo es number, el valor por defecto también debe ser numérico.

terminalCommands:
  "terraform init":
    - when:
        not_match: 'terraform\s*\{'
      output: |
        Initializing the backend...

        ╷
        │ Error: Missing terraform block
        │
        │ A terraform block is required. Add a terraform {} block.
        ╵
      exitCode: 1
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform plan":
    - when:
        custom: |
          (code) => {
            const hasType = /type\s*=/.test(code);
            const hasDefault = /default\s*=/.test(code);
            return !hasType && hasDefault;
          }
      output: |
        ╷
        │ Warning: Variable type not explicitly set
        │
        │ The variable "instance_count" has a default value of "2" (string)
        │ but is used in a context that expects a number. Terraform will attempt
        │ implicit type conversion which may produce unexpected results.
        ╵

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0
    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform validate":
    - when:
        not_match: 'type\s*='
      output: |
        ╷
        │ Warning: Missing variable type constraint
        │
        │   on main.tf line 1, in variable "instance_count":
        │    1: variable "instance_count" {
        │
        │ It is recommended to set an explicit type for all variables to prevent
        │ unintended type coercion.
        ╵

        Success! The configuration is valid, but there were some warnings.
      exitCode: 0
    - output: "Success! The configuration is valid."
      exitCode: 0
