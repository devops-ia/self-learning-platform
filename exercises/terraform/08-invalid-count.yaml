id: "tf-08-invalid-count"
title: "Count inválido"
briefing: "El meta-argumento count tiene un valor entre comillas. Terraform espera un número, no un string. Corrige el tipo."
prerequisites: []
language: "hcl"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_instance" "web" {
    count = "2"

    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"

    tags = {
      Name = "web-${count.index}"
    }
  }

hints:
  - "El error dice \"Inappropriate value for attribute count: a number is required\". El valor está entre comillas."
  - "count = \"2\" es un string. count = 2 (sin comillas) es un número. Terraform necesita un número."
  - "Solución: cambia count = \"2\" por count = 2."
successMessage: |
  ¡Correcto! count ahora es un número.

  Lo que aprendiste:
  - count debe ser un número, nunca un string
  - En HCL, "2" es string y 2 es número — la diferencia importa
  - count.index da el índice (0, 1, 2...) de cada instancia
  - count = 0 es válido y significa "no crear este recurso" (útil en condicionales)

i18n:
  en:
    title: "Invalid count"
    briefing: "The count meta-argument has a value in quotes. Terraform expects a number, not a string. Fix the type."
    hints:
      - "The error says \"Inappropriate value for attribute count: a number is required\". The value is in quotes."
      - "count = \"2\" is a string. count = 2 (without quotes) is a number. Terraform needs a number."
      - "Solution: change count = \"2\" to count = 2."
    successMessage: |
      Correct! count is now a number.

      What you learned:
      - count must be a number, never a string
      - In HCL, "2" is a string and 2 is a number — the difference matters
      - count.index gives the index (0, 1, 2...) of each instance
      - count = 0 is valid and means "don't create this resource" (useful in conditionals)

validations:
  - type: syntax
    errorMessage: "count no puede ser un string."
    check:
      match: 'count\s*=\s*"'
    failMessage: |
      Error: count debe ser un número, no un string

      count = "2" es un string. Terraform requiere que count sea un valor numérico.
      Quita las comillas para que sea un número: count = 2.

  - type: semantic
    errorMessage: "count debe ser un número entero."
    check:
      not_match: 'count\s*=\s*\d+'
    failMessage: |
      Error: count necesita un valor numérico

      El meta-argumento count determina cuántas instancias del recurso se crean.
      Debe ser un número entero: count = 2.

  - type: intention
    errorMessage: "count debe ser mayor que 0 para crear recursos."
    check:
      custom: |
        (code) => {
          const match = code.match(/count\s*=\s*(\d+)/);
          if (match && parseInt(match[1], 10) === 0) {
            return {
              passed: false,
              errorMessage: `Warning: count = 0 no creará ningún recurso

        Con count = 0, Terraform no creará ninguna instancia de este recurso.
        Si la intención es crear recursos, usa un valor mayor que 0.`
            };
          }
          return { passed: true };
        }
    failMessage: |
      Warning: count = 0 no creará ningún recurso

      Con count = 0, Terraform no creará ninguna instancia de este recurso.
      El plan mostrará que no hay cambios a realizar.

      Si la intención es crear recursos, cambia count a un valor mayor que 0.

      Nota: count = 0 es válido y se usa a veces en lógica condicional para
      habilitar o deshabilitar recursos según el contexto, por ejemplo:
        count = var.create_instance ? 1 : 0

terminalCommands:
  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform plan":
    - when:
        match: 'count\s*=\s*"'
      output: |
        ╷
        │ Error: Incorrect attribute value type
        │
          on main.tf line 14, in resource "aws_instance" "web":
           14:   count = "2"
        │
        │ Inappropriate value for attribute "count": a number is required.
        ╵
      exitCode: 1
    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.web[0] will be created
          + resource "aws_instance" "web" {
              + ami           = "ami-0c55b159cbfafe1f0"
              + instance_type = "t2.micro"
            }

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform validate":
    - when:
        match: 'count\s*=\s*"'
      output: |
        ╷
        │ Error: Incorrect attribute value type
        │
        │   on main.tf line 14:
        │
        │ Inappropriate value for attribute "count": a number is required.
        ╵
      exitCode: 1
    - output: "Success! The configuration is valid."
      exitCode: 0
