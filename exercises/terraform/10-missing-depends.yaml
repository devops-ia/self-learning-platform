id: "tf-10-missing-depends"
title: "Dependencia no declarada"
briefing: "La instancia necesita que la base de datos esté lista antes de arrancar, pero Terraform no detecta esta dependencia automáticamente. Declárala explícitamente."
prerequisites: []
language: "hcl"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_db_instance" "database" {
    engine         = "mysql"
    instance_class = "db.t3.micro"
    allocated_storage = 20
    username       = "admin"
    password       = "supersecret"
  }

  resource "aws_instance" "app" {
    ami           = "ami-0c55b159cbfafe1f0"
    instance_type = "t2.micro"

    user_data = <<-EOF
      #!/bin/bash
      echo "DB_HOST=${aws_db_instance.database.endpoint}" > /etc/app.env
      systemctl start app
    EOF
  }

hints:
  - "Ejecuta terraform plan. Observa el warning sobre el orden de creación. La app necesita la BD, pero Terraform no lo sabe."
  - "depends_on se añade dentro del recurso que tiene la dependencia (aws_instance.app) y lista los recursos de los que depende."
  - "Solución: añade depends_on = [aws_db_instance.database] dentro del recurso aws_instance.app."
successMessage: |
  ¡Correcto! La dependencia está declarada explícitamente.

  Lo que aprendiste:
  - Terraform detecta dependencias automáticas cuando un recurso referencia a otro
  - depends_on se usa cuando la dependencia existe pero Terraform no la detecta
  - depends_on = [] es una lista de referencias a recursos (sin comillas)
  - terraform graph muestra el grafo de dependencias para verificar el orden
  - Las dependencias innecesarias ralentizan el apply; usa depends_on solo cuando sea necesario

i18n:
  en:
    title: "Undeclared dependency"
    briefing: "The instance needs the database to be ready before starting, but Terraform doesn't detect this dependency automatically. Declare it explicitly."
    hints:
      - "Run terraform plan. Notice the warning about creation order. The app needs the DB, but Terraform doesn't know."
      - "depends_on is added inside the resource that has the dependency (aws_instance.app) and lists the resources it depends on."
      - "Solution: add depends_on = [aws_db_instance.database] inside the aws_instance.app resource."
    successMessage: |
      Correct! The dependency is explicitly declared.

      What you learned:
      - Terraform detects automatic dependencies when a resource references another
      - depends_on is used when the dependency exists but Terraform doesn't detect it
      - depends_on = [] is a list of resource references (without quotes)
      - terraform graph shows the dependency graph to verify order
      - Unnecessary dependencies slow down apply; use depends_on only when necessary

validations:
  - type: semantic
    errorMessage: "Falta depends_on para declarar la dependencia."
    check:
      not_contains: "depends_on"
    failMessage: |
      Error: Dependencia implícita no detectada por Terraform

      La instancia app necesita que la base de datos esté disponible antes de arrancar,
      pero no hay ninguna referencia directa entre ellas que Terraform pueda detectar.
      Sin depends_on, Terraform las creará en paralelo y app puede fallar al conectar.

  - type: intention
    errorMessage: "depends_on debe referenciar aws_db_instance.database."
    check:
      custom: |
        (code) => {
          if (code.includes("depends_on") && !code.includes("aws_db_instance.database")) {
            return {
              passed: false,
              errorMessage: `Error: depends_on debe referenciar el recurso correcto

        La dependencia es sobre la base de datos. depends_on debe incluir
        aws_db_instance.database para que Terraform sepa que debe crear
        la BD antes que la instancia app.`
            };
          }
          return { passed: true };
        }
    failMessage: |
      Error: depends_on debe referenciar el recurso correcto

      La instancia app necesita que la base de datos esté disponible antes de arrancar.
      depends_on debe incluir aws_db_instance.database para asegurar que Terraform
      cree la base de datos primero.

      Usa la sintaxis:
        depends_on = [aws_db_instance.database]

      dentro del recurso aws_instance.app para establecer la dependencia explícita.
      Sin esto, Terraform puede intentar crear ambos recursos en paralelo.

  - type: syntax
    errorMessage: "depends_on debe ser una lista."
    check:
      custom: |
        (code) => {
          if (code.includes("depends_on") && !/depends_on\s*=\s*\[/.test(code)) {
            return {
              passed: false,
              errorMessage: `Error: depends_on debe ser una lista

        depends_on espera una lista de referencias a recursos:
        depends_on = [aws_db_instance.database]
        Nota: sin comillas, es una referencia directa al recurso.`
            };
          }
          return { passed: true };
        }
    failMessage: |
      Error: depends_on debe ser una lista

      El meta-argumento depends_on espera una lista de referencias a recursos,
      incluso si solo hay una dependencia.

      Usa la sintaxis correcta:
        depends_on = [aws_db_instance.database]

      Notas importantes:
      - Las referencias van entre corchetes []
      - Sin comillas (es una referencia directa al recurso, no un string)
      - Puedes incluir múltiples dependencias: [recurso1, recurso2]

terminalCommands:
  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform plan":
    - when:
        not_contains: "depends_on"
      output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_instance.app will be created
          + resource "aws_instance" "app" {
              + ami           = "ami-0c55b159cbfafe1f0"
              + instance_type = "t2.micro"
            }

          # aws_db_instance.database will be created
          + resource "aws_db_instance" "database" {
              + engine         = "mysql"
              + instance_class = "db.t3.micro"
            }

        Plan: 2 to add, 0 to change, 0 to destroy.

        Warning: Resource ordering may be incorrect. aws_instance.app
        depends on the database being available, but Terraform may create
        them in parallel. Consider adding depends_on to ensure correct
        ordering.
      exitCode: 0
    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_db_instance.database will be created
          + resource "aws_db_instance" "database" {
              + engine         = "mysql"
              + instance_class = "db.t3.micro"
              + endpoint       = (known after apply)
            }

          # aws_instance.app will be created (after aws_db_instance.database)
          + resource "aws_instance" "app" {
              + ami           = "ami-0c55b159cbfafe1f0"
              + instance_type = "t2.micro"
            }

        Plan: 2 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform graph":
    - when:
        not_contains: "depends_on"
      output: |
        digraph {
          compound = "true"
          "aws_instance.app"
          "aws_db_instance.database"
          "root" -> "aws_instance.app"
          "root" -> "aws_db_instance.database"
        }

        Note: aws_instance.app and aws_db_instance.database have no
        dependency relationship. They will be created in parallel.
      exitCode: 0
    - output: |
        digraph {
          compound = "true"
          "aws_instance.app"
          "aws_db_instance.database"
          "aws_instance.app" -> "aws_db_instance.database"
          "root" -> "aws_instance.app"
        }

        Note: aws_instance.app depends on aws_db_instance.database.
        The database will be created first.
      exitCode: 0
