id: "tf-11-broken-lifecycle"
title: "Lifecycle incorrecto"
briefing: "La base de datos de producción tiene prevent_destroy = \"true\" (un string). Terraform necesita un booleano. Corrige el tipo para proteger el recurso."
prerequisites: []
language: "hcl"
initialCode: |
  terraform {
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = ">= 5.0"
      }
    }
  }

  provider "aws" {
    region = "us-east-1"
  }

  resource "aws_db_instance" "production" {
    engine         = "postgres"
    instance_class = "db.r5.large"
    allocated_storage = 100
    username       = "admin"
    password       = "production-secret"

    lifecycle {
      prevent_destroy = "true"
    }
  }

hints:
  - "El error dice \"a bool is required\". Busca el valor entre comillas que debería ser un booleano."
  - "En HCL, \"true\" es un string y true (sin comillas) es un booleano. prevent_destroy espera un booleano."
  - "Solución: cambia prevent_destroy = \"true\" por prevent_destroy = true."
successMessage: |
  ¡Correcto! prevent_destroy ahora es un booleano.

  Lo que aprendiste:
  - En HCL, true/false son booleanos; "true"/"false" son strings
  - prevent_destroy = true impide que terraform destroy elimine el recurso
  - El bloque lifecycle también soporta: create_before_destroy, ignore_changes, replace_triggered_by
  - Es buena práctica proteger recursos de producción críticos (bases de datos, buckets) con prevent_destroy

i18n:
  en:
    title: "Incorrect lifecycle"
    briefing: "The production database has prevent_destroy = \"true\" (a string). Terraform needs a boolean. Fix the type to protect the resource."
    hints:
      - "The error says \"a bool is required\". Look for the quoted value that should be a boolean."
      - "In HCL, \"true\" is a string and true (without quotes) is a boolean. prevent_destroy expects a boolean."
      - "Solution: change prevent_destroy = \"true\" to prevent_destroy = true."
    successMessage: |
      Correct! prevent_destroy is now a boolean.

      What you learned:
      - In HCL, true/false are booleans; "true"/"false" are strings
      - prevent_destroy = true prevents terraform destroy from deleting the resource
      - The lifecycle block also supports: create_before_destroy, ignore_changes, replace_triggered_by
      - It's good practice to protect critical production resources (databases, buckets) with prevent_destroy

validations:
  - type: syntax
    errorMessage: "prevent_destroy no puede ser un string."
    check:
      match: 'prevent_destroy\s*=\s*"(true|false)"'
    failMessage: |
      Error: prevent_destroy es boolean, no string

      prevent_destroy = "true" es un string. Terraform necesita un valor booleano.
      En HCL, los booleanos se escriben sin comillas: true o false.

  - type: semantic
    errorMessage: "prevent_destroy debe ser true o false."
    check:
      not_match: 'prevent_destroy\s*=\s*(true|false)'
    failMessage: |
      Error: prevent_destroy necesita un valor booleano

      El atributo prevent_destroy dentro del bloque lifecycle debe ser true o false (sin comillas).
      true = impide que terraform destroy elimine el recurso.
      false = permite la eliminación normal.

  - type: intention
    errorMessage: "El recurso necesita un bloque lifecycle."
    check:
      not_contains: "lifecycle"
    failMessage: |
      Error: Falta el bloque lifecycle

      El bloque lifecycle {} va dentro del recurso y controla el comportamiento
      durante create, update y destroy. prevent_destroy es uno de sus atributos.

terminalCommands:
  "terraform init":
    - output: |
        Initializing the backend...

        Initializing provider plugins...
        - Finding hashicorp/aws versions matching ">= 5.0"...
        - Installing hashicorp/aws v5.31.0...
        - Installed hashicorp/aws v5.31.0 (signed by HashiCorp)

        Terraform has been successfully initialized!
      exitCode: 0

  "terraform plan":
    - when:
        match: 'prevent_destroy\s*=\s*"(true|false)"'
      output: |
        ╷
        │ Error: Incorrect attribute value type
        │
          on main.tf, in resource "aws_db_instance" "production":
        │
        │ Inappropriate value for attribute "prevent_destroy": a bool is
        │ required.
        ╵
      exitCode: 1
    - output: |
        Terraform used the selected providers to generate the following execution
        plan. Resource actions are indicated with the following symbols:
          + create

        Terraform will perform the following actions:

          # aws_db_instance.production will be created
          + resource "aws_db_instance" "production" {
              + engine         = "postgres"
              + instance_class = "db.r5.large"
              + allocated_storage = 100
              + (lifecycle: prevent_destroy = true)
            }

        Plan: 1 to add, 0 to change, 0 to destroy.
      exitCode: 0

  "terraform validate":
    - when:
        match: 'prevent_destroy\s*=\s*"(true|false)"'
      output: |
        ╷
        │ Error: Incorrect attribute value type
        │
        │ Inappropriate value for attribute "prevent_destroy": a bool is required.
        ╵
      exitCode: 1
    - output: "Success! The configuration is valid."
      exitCode: 0
